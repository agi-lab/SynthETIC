---
title: "The Inclusion of Claim Covariates in the Generation of SynthETIC Claims"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The Inclusion of Claim Covariates in the Generation of SynthETIC Claims}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette aims to illustrate how the inclusion of covariates can influence the severity of the claims generated using the `SynthETIC` package. The distributional assumptions shown in this vignette are consistent with the default assumptions of the `SynthETIC` package (an Auto Liability portfolio). The inclusion of covariates aims to be a minor adjustment step to modelled claim sizes after Step 2: *Claim size* discussed in the [`SynthETIC-demo` vignette](SynthETIC-demo.html).

In particular, with this demo we will construct:

------------------------------------------------------------------------------------------
Description                     R Object
------------------------------- ----------------------------------------------------------
Covariate Inputs                `covariate_obj` = various factors, their levels and relativities for covariate frequency and claim severity

Covariate Outputs               `covariates_data_obj` = dataset of assigned covariates for each claim

*S_adj*, claim size             `claim_size_w_cov[[i]]` = claim size for all claims that occurred in period *i* after adjustment for covariates
------------------------------------------------------------------------------------------

Reference
---
For a full description of `SythETIC`'s covariates module, readers should refer to:

XXX_TO_BE_INPUTTED_XXX (WORK IN PROGRESS)

To cite this package in publications, please use:
```{r, eval=FALSE}
citation("SynthETIC_cov")
```

`SynthETIC` Set Up
---

We set up package-wise global parameters demonstrated in the [`SynthETIC-demo` vignette](SynthETIC-demo.html) and perform modelling Steps 1 and 2 to generate the claim frequency and claim sizes under the default assumptions. Note that changing these assumptions for Steps 1 and 2 do not affect how covariates are implemented.

```{r}
library(SynthETIC)
set.seed(20200131)

set_parameters(ref_claim = 200000, time_unit = 1/4)
ref_claim <- return_parameters()[1]
time_unit <- return_parameters()[2]

years <- 10
I <- years / time_unit
E <- c(rep(12000, I)) # effective annual exposure rates
lambda <- c(rep(0.03, I))

# Modelling Steps 1-2
n_vector <- claim_frequency(I = I, E = E, freq = lambda)
occurrence_times <- claim_occurrence(frequency_vector = n_vector)
claim_sizes <- claim_size(frequency_vector = n_vector)
```

Applying Covariates
---

To apply simulated covariates to `SynthETIC` claim sizes, a `covariates` is used in conjunction with the `claim_size_adj()` function to both simulate covariate combinations and apply adjusted claim sizes.

```{r}
covariates_obj <- SynthETIC::covariates_obj
claim_size_covariates <- claim_size_adj(covariates_obj, claim_sizes)
covariates_data_obj <- claim_size_covariates$covariates_data
claim_size_w_cov <- claim_size_covariates$claim_size_adj
```

Modelling Steps 3-5
---

Just as in Steps 1-2, Steps 3 onwards also do not require any specific adjustment in relation to implementing covariates. Guidance on implementing these modelling steps can be found in the [`SynthETIC-demo` vignette](SynthETIC-demo.html). We can see from the example below that the inclusion of covariates primarily has an impact on claim sizes and thus any following modelling steps that are also impacted from the adjusted claim sizes. Note that the number of claims (`n_vector`) and the time at which they occur (`occurrence_times`) are unaffected by covariates.

```{r}
generate_claims_dataset <- function(claim_size_list) {
    
    # SynthETIC Steps 3-5
    notidel <- claim_notification(n_vector, claim_size_list)
    setldel <- claim_closure(n_vector, claim_size_list)
    no_payments <- claim_payment_no(n_vector, claim_size_list)
    
    claim_dataset <- generate_claim_dataset(
      frequency_vector = n_vector,
      occurrence_list = occurrence_times,
      claim_size_list = claim_size_list,
      notification_list = notidel,
      settlement_list = setldel,
      no_payments_list = no_payments
    )
    
    claim_dataset
}

claim_dataset <- generate_claims_dataset(claim_size_list = claim_sizes)
claim_dataset_w_cov <- generate_claims_dataset(claim_size_list = claim_size_w_cov)

head(claim_dataset)
head(claim_dataset_w_cov)
```

Simulating the Effects of Different Covariates (WORK IN PROGRESS)
---

Temporary note: random numbers (very) loosely (and partially guess-work) backed by:
(https://www.abs.gov.au/statistics/industry/tourism-and-transport/survey-motor-vehicle-use-australia/latest-release)
(https://www.abs.gov.au/statistics/industry/tourism-and-transport/sales-new-motor-vehicles/latest-release#data-downloads)

This part of vignette is moreso a proof of concept to use different covariates.

```{r}
factors_tmp <- list(
    "Vehicle Type" = c("Passenger", "Light Commerical", "Medium Goods", "Heavy Goods"),
    "Business Use" = c("Y", "N")
)

relativity_freq_tmp <- relativity_template(factors_tmp)
relativity_sev_tmp <- relativity_template(factors_tmp)

# Default Values
relativity_freq_tmp$relativity <- c(
    5, 1.5, 0.35, 0.25,
    1, 4,
    1, 0.6,
    0.35, 0.01,
    0.25, 0,
    2.5, 5
)

relativity_sev_tmp$relativity <- c(
    0.25, 0.75, 1, 3,
    1, 1,
    1, 1,
    1, 1,
    1, 1,
    2, 0.5
)

covariates_obj_tmp <- covariates(factors_tmp)
covariates_obj_tmp <- set.covariates_relativity(
    covariates = covariates_obj_tmp, 
    relativity = relativity_freq_tmp, 
    freq_sev = "freq"
)
covariates_obj_tmp <- set.covariates_relativity(
    covariates = covariates_obj_tmp, 
    relativity = relativity_sev_tmp, 
    freq_sev = "sev"
)

claim_size_covariates_tmp <- claim_size_adj(covariates_obj_tmp, claim_sizes)

cbind(
    head(claim_size_covariates$covariates_data$data)
    ,head(claim_size_covariates$claim_size_adj[[1]])
)

cbind(
    head(claim_size_covariates_tmp$covariates_data$data)
    ,head(claim_size_covariates_tmp$claim_size_adj[[1]])
)
```


Using Known Covariates Values (WORK IN PROGRESS)
---

If covariate values for each claim occurrence was known, then we can directly use them in adjusting claim sizes. E.g. in this instance, the first 50 claims always belonged to `Passenger`, next 50 claims belonged to `Light Commerical`.

```{r}
claim_sizes_tmp <- list(c(
    rexp(n = 25, rate = 1),
    rgamma(n = 25, shape = 1.5),
    rexp(n = 25, rate = 1.25),
    rgamma(n = 25, shape = 2)
))

tmp_data <- data.frame(
    "Vehicle Type" = rep(rep(c("Passenger", "Light Commerical"), each = 25), times = 2),
    "Business Use" = c(rep("N", times = 50), rep("Y", times = 50))
)
colnames(tmp_data) <- c("Vehicle Type", "Business Use")

covariates_data_tmp <- covariates_data(
    covariates_obj_tmp, 
    data = tmp_data, 
    covariates_id = list(c(100:51, 1:50))
)

claim_sizes_adj_tmp <- claim_size_adj.fit(
    covariates_data = covariates_data_tmp,
    claim_size = claim_sizes_tmp
)

```

